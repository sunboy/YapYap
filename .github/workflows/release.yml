name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: macos-15
    permissions:
      contents: write  # needed to push appcast.xml and create GitHub Release

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Select Xcode 16
        run: sudo xcode-select -s /Applications/Xcode_16.app/Contents/Developer

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: /tmp/spm-cache
          key: spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: spm-

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Download Sparkle tools
        run: |
          curl -L https://github.com/sparkle-project/Sparkle/releases/download/2.9.0/Sparkle-2.9.0.tar.xz -o /tmp/sparkle.tar.xz
          mkdir -p /tmp/sparkle
          tar -xf /tmp/sparkle.tar.xz -C /tmp/sparkle
          echo "sign_update: $(/tmp/sparkle/bin/sign_update --version 2>&1 || echo 'found')"

      - name: Import Developer ID certificate
        env:
          CERT_P12: ${{ secrets.DEVELOPER_ID_CERT_P12 }}
          CERT_PASSWORD: ${{ secrets.DEVELOPER_ID_CERT_PASSWORD }}
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/build.keychain
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "$CERT_P12" | base64 --decode > /tmp/cert.p12
          security import /tmp/cert.p12 -k "$KEYCHAIN_PATH" -P "$CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          rm /tmp/cert.p12

          security list-keychain -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"

          # Remove any non-Developer-ID certs to avoid team resolution conflicts
          for HASH in $(security find-identity -v "$KEYCHAIN_PATH" | grep -v "Developer ID Application" | grep -oE '[A-F0-9]{40}'); do
            security delete-certificate -Z "$HASH" "$KEYCHAIN_PATH" 2>/dev/null || true
          done
          echo "Identities in keychain after cleanup:"
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV

      - name: Import Sparkle private key into Keychain
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          security add-generic-password \
            -a "ed25519" \
            -s "Sparkle Key" \
            -w "$SPARKLE_PRIVATE_KEY" \
            "$KEYCHAIN_PATH"

      - name: Extract version from tag
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "DMG_NAME=YapYap-v${VERSION}.dmg" >> $GITHUB_ENV
          echo "Building version: $VERSION"

      - name: Resolve Swift packages
        run: |
          xcodebuild -resolvePackageDependencies \
            -project YapYap.xcodeproj \
            -scheme YapYap \
            -clonedSourcePackagesDirPath /tmp/spm-cache

      - name: Archive
        run: |
          mkdir -p build
          xcodebuild -project YapYap.xcodeproj \
            -scheme YapYap \
            -configuration Release \
            archive \
            -archivePath build/YapYap.xcarchive \
            DEVELOPMENT_TEAM="SRB6ZCP58T" \
            CODE_SIGN_IDENTITY="Developer ID Application: Sandeep Thuthike (SRB6ZCP58T)" \
            CODE_SIGN_STYLE="Manual" \
            OTHER_CODE_SIGN_FLAGS="--keychain $KEYCHAIN_PATH --timestamp" \
            -clonedSourcePackagesDirPath /tmp/spm-cache

      - name: Export and re-sign app
        run: |
          mkdir -p build/release
          # Copy app from archive
          cp -R build/YapYap.xcarchive/Products/Applications/YapYap.app build/release/YapYap.app
          # Re-sign deep with Developer ID using our keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          codesign --force --deep --sign "Developer ID Application: Sandeep Thuthike (SRB6ZCP58T)" \
            --keychain "$KEYCHAIN_PATH" \
            --options runtime \
            --timestamp \
            --entitlements YapYap/YapYap.entitlements \
            build/release/YapYap.app

      - name: Verify signature
        run: |
          codesign --verify --deep --strict --verbose=2 build/release/YapYap.app
          # spctl check skipped â€” app is unnotarized at this stage, notarization happens next

      - name: Create DMG
        run: |
          create-dmg \
            --volname "YapYap" \
            --window-pos 400 300 \
            --window-size 640 480 \
            --icon-size 80 \
            --icon "YapYap.app" 160 240 \
            --app-drop-link 480 240 \
            --no-internet-enable \
            "build/$DMG_NAME" \
            build/release/YapYap.app

      - name: Notarize DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APP_SPECIFIC_PASSWORD: ${{ secrets.APP_SPECIFIC_PASSWORD }}
          TEAM_ID: ${{ secrets.TEAM_ID }}
        run: |
          xcrun notarytool submit "build/$DMG_NAME" \
            --apple-id "$APPLE_ID" \
            --team-id "$TEAM_ID" \
            --password "$APP_SPECIFIC_PASSWORD" \
            --wait \
            --output-format json

      - name: Staple notarization ticket
        run: |
          xcrun stapler staple "build/$DMG_NAME"
          xcrun stapler validate "build/$DMG_NAME"

      - name: Generate Sparkle EdDSA signature
        run: |
          SIG=$(/tmp/sparkle/bin/sign_update "build/$DMG_NAME")
          echo "SPARKLE_SIGNATURE=$SIG" >> $GITHUB_ENV
          echo "edSignature: $SIG"

      - name: Get DMG file size
        run: |
          SIZE=$(stat -f%z "build/$DMG_NAME")
          echo "DMG_SIZE=$SIZE" >> $GITHUB_ENV

      - name: Update appcast.xml
        run: |
          PUB_DATE=$(date -u "+%a, %d %b %Y %H:%M:%S +0000")
          DOWNLOAD_URL="https://github.com/sunboy/yapyap/releases/download/v${VERSION}/${DMG_NAME}"

          python3 - "$VERSION" "$PUB_DATE" "$DOWNLOAD_URL" "$DMG_SIZE" "$SPARKLE_SIGNATURE" <<'PYEOF'
          import sys

          version, pub_date, url, size, sig = sys.argv[1], sys.argv[2], sys.argv[3], sys.argv[4], sys.argv[5]

          new_item = f"""        <item>
              <title>Version {version}</title>
              <link>https://github.com/sunboy/yapyap/releases/tag/v{version}</link>
              <sparkle:version>{version}</sparkle:version>
              <sparkle:shortVersionString>{version}</sparkle:shortVersionString>
              <description><![CDATA[
                  <h2>What's New in {version}</h2>
                  <p>See <a href="https://github.com/sunboy/yapyap/releases/tag/v{version}">release notes</a> for details.</p>
              ]]></description>
              <pubDate>{pub_date}</pubDate>
              <enclosure
                  url="{url}"
                  sparkle:version="{version}"
                  sparkle:shortVersionString="{version}"
                  length="{size}"
                  type="application/octet-stream"
                  sparkle:edSignature="{sig}"
              />
              <sparkle:minimumSystemVersion>14.0</sparkle:minimumSystemVersion>
          </item>"""

          with open("Distribution/appcast.xml", "r") as f:
              content = f.read()

          updated = content.replace("    </channel>", new_item + "\n\n    </channel>")

          with open("Distribution/appcast.xml", "w") as f:
              f.write(updated)

          print("appcast.xml updated successfully")
          PYEOF

      - name: Commit updated appcast.xml
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Distribution/appcast.xml
          git commit -m "chore: update appcast.xml for v${VERSION}"
          git push origin HEAD:main

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "v${VERSION}" \
            "build/${DMG_NAME}" \
            --title "YapYap v${VERSION}" \
            --notes "## YapYap v${VERSION}

          Download the DMG below and drag YapYap to your Applications folder.

          **Requirements:** macOS 14.0+, Apple Silicon (M1+)

          ### What's New
          _Add release notes here or edit this release on GitHub._

          ---
          **Full Changelog:** https://github.com/sunboy/yapyap/commits/v${VERSION}"

      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain "$KEYCHAIN_PATH" || true
