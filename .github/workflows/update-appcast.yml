name: Update Appcast

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to sign (e.g. 0.2.2)'
        required: true
        type: string

jobs:
  update-appcast:
    runs-on: macos-15
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Sparkle tools
        run: |
          curl -L https://github.com/sparkle-project/Sparkle/releases/download/2.9.0/Sparkle-2.9.0.tar.xz -o /tmp/sparkle.tar.xz
          mkdir -p /tmp/sparkle
          tar -xf /tmp/sparkle.tar.xz -C /tmp/sparkle

      - name: Download DMG from release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ inputs.version }}"
          DMG_NAME="YapYap-v${VERSION}.dmg"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "DMG_NAME=$DMG_NAME" >> $GITHUB_ENV
          gh release download "v${VERSION}" --pattern "$DMG_NAME" --dir /tmp/dmg
          echo "Downloaded: $(ls /tmp/dmg/)"

      - name: Sign DMG with Sparkle EdDSA key
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          # Write key to temp file and sign
          echo "$SPARKLE_PRIVATE_KEY" > /tmp/sparkle_key.txt
          SIG=$(/tmp/sparkle/bin/sign_update --ed-key-file /tmp/sparkle_key.txt "/tmp/dmg/$DMG_NAME" 2>&1)
          rm /tmp/sparkle_key.txt
          echo "sign_update output: $SIG"
          # Extract base64 signature (88 chars for EdDSA)
          ACTUAL_SIG=$(echo "$SIG" | grep -oE '[A-Za-z0-9+/=]{80,}' | head -1)
          if [ -z "$ACTUAL_SIG" ]; then
            echo "âŒ Could not extract signature from: $SIG"
            exit 1
          fi
          echo "SPARKLE_SIGNATURE=$ACTUAL_SIG" >> $GITHUB_ENV
          echo "Signature: $ACTUAL_SIG"

      - name: Get DMG file size
        run: |
          SIZE=$(stat -f%z "/tmp/dmg/$DMG_NAME")
          echo "DMG_SIZE=$SIZE" >> $GITHUB_ENV

      - name: Update appcast.xml
        run: |
          PUB_DATE=$(date -u "+%a, %d %b %Y %H:%M:%S +0000")
          DOWNLOAD_URL="https://github.com/sunboy/YapYap/releases/download/v${VERSION}/${DMG_NAME}"

          python3 - "$VERSION" "$PUB_DATE" "$DOWNLOAD_URL" "$DMG_SIZE" "$SPARKLE_SIGNATURE" <<'PYEOF'
          import sys

          version, pub_date, url, size, sig = sys.argv[1], sys.argv[2], sys.argv[3], sys.argv[4], sys.argv[5]

          new_item = f"""        <item>
              <title>Version {version}</title>
              <link>https://github.com/sunboy/YapYap/releases/tag/v{version}</link>
              <sparkle:version>{version}</sparkle:version>
              <sparkle:shortVersionString>{version}</sparkle:shortVersionString>
              <description><![CDATA[
                  <h2>What's New in {version}</h2>
                  <p>See <a href="https://github.com/sunboy/YapYap/releases/tag/v{version}">release notes</a> for details.</p>
              ]]></description>
              <pubDate>{pub_date}</pubDate>
              <enclosure
                  url="{url}"
                  sparkle:version="{version}"
                  sparkle:shortVersionString="{version}"
                  length="{size}"
                  type="application/octet-stream"
                  sparkle:edSignature="{sig}"
              />
              <sparkle:minimumSystemVersion>14.0</sparkle:minimumSystemVersion>
          </item>"""

          with open("Distribution/appcast.xml", "r") as f:
              content = f.read()

          updated = content.replace("    </channel>", new_item + "\n\n    </channel>")

          with open("Distribution/appcast.xml", "w") as f:
              f.write(updated)

          print("appcast.xml updated successfully")
          PYEOF

      - name: Commit and push appcast.xml
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Distribution/appcast.xml
          git commit -m "chore: update appcast.xml for v${VERSION}"
          git push origin HEAD:main
